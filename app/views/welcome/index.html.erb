<% content_for :stylesheet_links do %>
  <style type="text/css">
    body>header {
      text-align: center;
    }
    body>section {
      width: 90%;
      margin: 1em auto;
    }
  </style>
<% end %>
<header>
  <h1>Object Oriented Software Design (2013 Spring)</h1>
  <h2>Homework Submission System</h2>
</header>
<section>
  <% if not @email or not /@csie\.ntu\.edu\.tw/ =~ @email %>
  <section>
    <% if @email %>
    <p>You are logged-in as <span class="text-info"><%= @email %></span>.</p>
    <% end %>
    <p>Please <a href="/auth/google_oauth2">login</a> using your NTU-CSIE account.</p>
  </section>
  <% else %>
  <section>
    <p>Hi, <span class="text-info"><%= @email %></span>.</p>
    <p>Please submit your git repository for <strong>homework <%= @homework_number %></strong>.</p>
  </section>
  <%= form_tag({ :controller => 'path', :action => 'git'}, :method => :get, :id => 'git-submit', :class => 'form-inline') do %>
     <%= text_field_tag :path, nil, :class=> 'input-xlarge', :placeholder => 'git://github.com/octocat/Hello-World.git'  %>
    <%= submit_tag 'Submit', :class => 'btn btn-primary' %>
  <% end %>
  <section>
    <h4>Submission History</h4>
    <% if @submissions.empty? %>
    <p>No submission history available.</p>
    <% else %>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>#</th>
          <th>Git Repo</th>
          <th>Commit</th>
        </tr>
      </thead>
      <tbody>
        <% @submissions.each do |submission| %>
        <tr>
          <td><%= submission[:version] %></td>
          <td><%= submission[:repo] %></td>
          <td><%= submission[:info].id %></td>
        </tr>
        <% end %>
      </tbody>
    </table>
    <% end %>
  </section>
  <div id="dialog-loading" class="modal fade">
    <div class="modal-body">
      <center>
        <%= image_tag "ajax-loader.gif" %>
        <span>Please wait ...</span>
      </center>
    </div>
  </div>
  <div id="dialog-success" class="modal fade">
    <div class="modal-header">
      <h3><span class="dialog-message"></span></h3>
    </div>
    <div class="modal-body">
      <p>This is your <span class="dialog-version"></span> submission for homework <%= @homework_number %>.</p>
      <p>Git repository submitted:</p>
      <pre class="dialog-git-repo text-info"></pre>
      <p>Latest commit:</p>
      <pre class="dialog-commit-details text-info"></pre>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal">Close</button>
    </div>
  </div>
  <div id="dialog-failed" class="modal hide fade">
    <div class="modal-header">
      <h3><span class="dialog-message"></span></h3>
    </div>
    <div class="modal-body">
      <p>Complaints from server:</p>
      <pre class="dialog-error text-error"></pre>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal">Close</button>
    </div>
  </div>
  <script type="text/javascript">
    $(function() {
      $('#dialog-loading').modal({ backdrop: 'static', show: false });
      $('#git-submit').submit(function() {
        $('#dialog-loading').modal('show');
        $.ajax({
          url: $(this).attr('action'),
          data: $(this).serialize()
        }).done(function(res) {
          $('#dialog-loading').modal('hide');
          $('#git-submit :input:text').val('');

          var $dialog = $('#dialog-success');
          $('.dialog-message', $dialog).text(res.message);
          $('.dialog-version', $dialog).text(res.version);
          $('.dialog-git-repo', $dialog).text(res.repo);
          $('.dialog-commit-details', $dialog).text(
              'Commit: ' + res.info.id + '\n' +
              'Author: ' + res.info.author.name + ' <' + res.info.author.email + '>\n' +
              'Date: ' + res.info.authored_date
          );
          $dialog.modal('show');
        }).fail(function(jqxhr, textStatus, errorThrown) {
          $('#dialog-loading').modal('hide');

          var $dialog = $('#dialog-failed');
          var res = JSON.parse(jqxhr.responseText);
          $('.dialog-message', $dialog).text(res.message);
          $('.dialog-error', $dialog).text(res.error);
          $dialog.modal('show');
        });
        return false;
      });
    });
  </script>
  <% end %>
</section>
