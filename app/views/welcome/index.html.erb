<% content_for :stylesheet_links do %>
  <style type="text/css">
    body>header {
      text-align: center;
    }
    body>section {
      width: 90%;
      margin: 1em auto;
    }
  </style>
<% end %>
<header>
  <h1>Object Oriented Software Design (2013 Spring)</h1>
  <h2>Homework Submission System</h2>
</header>
<section>
<% if not @email or not /@csie\.ntu\.edu\.tw/ =~ @email %>
  <section>
    <% if @email %>
      <p>You are logged-in as <span class="text-info"><%= @email %></span>.</p>
    <% end %>
    <p>Please <a href="/auth/google_oauth2">login</a> using your NTU-CSIE account.</p>
  </section>
<% else %>
  <section>
    <p>Hi, <span class="text-info"><%= @email %></span>.</p>
    <p>Please submit your git repository for <strong>homework <%= @homework_number %></strong>.</p>
  </section>
  <%= form_tag({ :controller => 'path', :action => 'git'}, :method => :get, :id => 'git-submit', :class => 'form-inline') do %>
     <%= text_field_tag :path, nil, :class=> 'input-xlarge', :placeholder => 'git://github.com/octocat/Hello-World.git'  %>
    <%= submit_tag 'Submit', :class => 'btn btn-primary' %>
  <% end %>
  <div id="dialog-success" class="modal hide fade">
    <div class="modal-header">
      <h3><span class="dialog-message"></span></h3>
    </div>
    <div class="modal-body">
      <p>Git repository submitted:</p>
      <pre class="dialog-git-repo text-info"></pre>
      <p>Latest commit:</p>
      <pre class="dialog-commit-details text-info"></pre>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal">Close</button>
    </div>
  </div>
  <div id="dialog-failed" class="modal hide fade">
    <div class="modal-header">
      <h3><span class="dialog-message"></span></h3>
    </div>
    <div class="modal-body">
      <p>Complaints from server:</p>
      <pre class="dialog-error text-error"></pre>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal">Close</button>
    </div>
  </div>
  <script type="text/javascript">
    $(function() {
      $('#git-submit').submit(function() {
        $.ajax({
          url: $(this).attr('action'),
          data: $(this).serialize()
        }).done(function(res) {
          var $dialog = $('#dialog-success');
          $('.dialog-message', $dialog).text(res.message);
          $('.dialog-git-repo', $dialog).text(res.repo);
          $('.dialog-commit-details', $dialog).text(
              'Commit: ' + res.info.id + '\n' +
              'Author: ' + res.info.author.name + ' <' + res.info.author.email + '>\n' +
              'Date: ' + res.info.authored_date
          );
          $dialog.modal('show');
        }).fail(function(jqxhr, textStatus, errorThrown) {
          var $dialog = $('#dialog-failed');
          var res = JSON.parse(jqxhr.responseText);
          $('.dialog-message', $dialog).text(res.message);
          $('.dialog-error', $dialog).text(res.error);
          $dialog.modal('show');
        });
        return false;
      });
    });
  </script>
<% end %>
</section>
